[{"id":"e9cabb74.fe91","type":"tab","label":"OL Connect API","disabled":false,"info":""},{"id":"51790cbc.40d12c","type":"tab","label":"Health Dashboard (not needed)","disabled":false,"info":""},{"id":"8fb980b3.1d7608","type":"tab","label":"temp (to be remove)","disabled":false,"info":""},{"id":"9d046ee7.fd5b38","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"676f881a.2970e","type":"mongodb-config","z":"","hostname":"127.0.0.1","port":"27017","db":"Test","name":"Test database"},{"id":"ba23399f.6256c8","type":"olc-server","z":"","host":"localhost","port":"9340","username":"ol-admin","password":"secret","name":"My Dev Server"},{"id":"93ad53ce.0a9168","type":"olc-server","z":"","host":"localhost","port":"9340","username":"ol-admin","password":"secret","name":"My Dev Server"},{"id":"793172d6.403c04","type":"ui_group","z":"","name":"Last refresh","tab":"31f79a51.af9836","disp":true,"width":"12","collapse":false},{"id":"31f79a51.af9836","type":"ui_tab","z":"","name":"Home","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"eca3b0d4.5b7868","type":"ui_group","z":"","name":"Group 1","tab":"33273e47.bcd172","order":1,"disp":false,"width":"6"},{"id":"33273e47.bcd172","type":"ui_tab","z":"","name":"switch test","icon":"dashboard","order":3},{"id":"8378d78.5c46728","type":"ui_group","z":"","name":"Memory","tab":"377f01b7.8869de","order":3,"disp":true,"width":"6"},{"id":"56329cc.047c7e4","type":"ui_group","z":"","name":"System Information","tab":"377f01b7.8869de","order":1,"disp":true,"width":"6"},{"id":"377f01b7.8869de","type":"ui_tab","z":"","name":"System","icon":"computer"},{"id":"24ff660a.29feda","type":"ui_group","z":"","name":"System Information","tab":"377f01b7.8869de","order":1,"disp":true,"width":"8","collapse":true},{"id":"ecfbd287.bb2578","type":"ui_group","z":"","name":"CPU Status","tab":"","order":2,"disp":true,"width":"8","collapse":true},{"id":"db5658b7.cb508","type":"ui_group","z":"","name":"Memory Status","tab":"","order":3,"disp":true,"width":"8","collapse":true},{"id":"dcb78f2d.54d3b8","type":"olc-server","z":"","host":"localhost","port":"9340","username":"ol-admin","password":"secret","name":"My Dev Server"},{"id":"58ab77d5.3bbc1","type":"olc-server","z":"","host":"localhost","port":"9340","username":"ol-admin","password":"secret","name":"My Dev Server"},{"id":"8472406d.86a92","type":"MySQLdatabase","z":"","host":"127.0.0.1","port":"3306","db":"objectiflune","tz":""},{"id":"32cf0589.c33222","type":"olc-server","z":"","host":"localhost","port":"9340","username":"ol-admin","password":"secret","name":"My Dev Server"},{"id":"e08a3881.c6fb88","type":"base64","z":"e9cabb74.fe91","name":"","action":"","property":"payload","x":1120,"y":540,"wires":[["a72c5cdc.fede4"]]},{"id":"e4014e2c.a36f8","type":"comment","z":"8fb980b3.1d7608","name":"Convert csv to json","info":"{\"RECORD\":\"000001\",\"CO\":\"F1657508.dc9\",\"LAYER\":\"DLY_DE_FR_00205_DUP.dot\",\"WCP\":3,\"CPF\":1,\"EMB4\":\"CARD 6703 7965 1141 6000 5 N5   \",\"UFM01\":\"MONSIEUR                043802\",\"UFM02\":\"CO COSSE BENOIT               \",\"UFM03\":\"RUE JACQUET             87    \",\"UFM04\":\"5580  ROCHEFORT               \",\"UFM07\":\"26 novembre 2019\",\"UFM11\":\"        BP/PB 1736    1000 BRU\",\"UFM95\":\"DC01047F74A5\",\"UFM99\":\"JJBEA129882005330352933\",\"UFM100\":\"|JJBEA129882005330352933�~ \",\"UFM901\":\"TBDTBD\",\"UFM902\":\"59995D1D5991D\"}\n","x":230,"y":100,"wires":[]},{"id":"86e81ca8.e697a","type":"inject","z":"8fb980b3.1d7608","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":140,"wires":[["c845fcb0.7a5d48"]]},{"id":"c845fcb0.7a5d48","type":"file in","z":"8fb980b3.1d7608","name":"","filename":"C:/red/data/belfius/1_19112703_F1657508.MAI","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":440,"y":140,"wires":[["e340ed9.2245c1"]]},{"id":"fdf0f1f6.2d682","type":"csv","z":"8fb980b3.1d7608","name":"","sep":";","hdrin":true,"hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","strings":true,"x":1030,"y":140,"wires":[["488489d1.78149"]]},{"id":"488489d1.78149","type":"debug","z":"8fb980b3.1d7608","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":140,"wires":[]},{"id":"e340ed9.2245c1","type":"function","z":"8fb980b3.1d7608","name":"Get rid of linebreak inside double quote","func":"//Fix: if there are any line breaks in between column values, then that column value will be wrapped in double quotes\n//first get all the double quoted values list using regex\nvar lineBreakList = msg.payload.match(/([\"'])(\\\\?)[\\s\\S]*?\\1/g);\n//search for line breaks using regex, if found replace it with empty value\nlineBreakList.forEach(function (item) {\n    msg.payload = msg.payload.replace(item, item.replace(/\\r?\\n|\\r/g, '<br \\/>'));\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":140,"wires":[["fdf0f1f6.2d682"]]},{"id":"e3766387.db7f2","type":"http in","z":"e9cabb74.fe91","name":"","url":"/newrefreshback","method":"post","upload":false,"swaggerDoc":"","x":200,"y":480,"wires":[["1c459b29.13510d","89a4b04d.15d238"]],"info":"Example: http://127.0.0.1:1880/pod/render/site/dashboard\n\n/:solution/:verb/:template/:section\n\nMaps to\nmsg.req.params.solution\nmsg.req.params.verb\nmsg.req.params.template\nmsg.req.params.section"},{"id":"6e4db292.5c1a44","type":"http request","z":"e9cabb74.fe91","name":"Image preview","method":"POST","ret":"bin","paytoqs":false,"url":"http://localhost:9340/rest/serverengine/workflow/contentcreation/imagepreview/{{{template}}}","tls":"","persist":false,"proxy":"","authType":"basic","x":840,"y":480,"wires":[["c8926362.86a63"]]},{"id":"c8926362.86a63","type":"switch","z":"e9cabb74.fe91","name":"status code","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"404","vt":"num"},{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":520,"wires":[["3c9a4b78.14cbb4"],["e08a3881.c6fb88","862361d7.090908"]]},{"id":"3c9a4b78.14cbb4","type":"file in","z":"e9cabb74.fe91","name":"error.jpg","filename":"C:/red/error.jpg","format":"","chunk":false,"sendError":false,"encoding":"none","x":1120,"y":480,"wires":[["e08a3881.c6fb88"]]},{"id":"e0231524.908b68","type":"http response","z":"e9cabb74.fe91","name":"","statusCode":"200","headers":{"content-type":"text/html"},"x":1400,"y":580,"wires":[]},{"id":"a72c5cdc.fede4","type":"function","z":"e9cabb74.fe91","name":"prepend image","func":"msg.payload = \"data:image/jpg;base64, \" + msg.payload;\ndelete msg.template;\nreturn msg;","outputs":1,"noerr":0,"x":1140,"y":580,"wires":[["e0231524.908b68","3a5372b6.95354e"]]},{"id":"86cf772d.be8c48","type":"comment","z":"e9cabb74.fe91","name":"-------------------------------------------------------------- Rasterize ---------------------------------------------------------","info":"# Raster\ncall a Connect template and rasterize \nthen return a base 64 string","x":460,"y":420,"wires":[]},{"id":"862361d7.090908","type":"image","z":"e9cabb74.fe91","name":"","width":"200","data":"payload","dataType":"msg","thumbnail":false,"active":true,"x":840,"y":580,"wires":[]},{"id":"2ab6e06b.8d40c","type":"file","z":"e9cabb74.fe91","name":"","filename":"c:\\temp\\lastjson.json","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"utf8","x":480,"y":800,"wires":[[]]},{"id":"6c201b13.43700c","type":"comment","z":"e9cabb74.fe91","name":"---- For debug purpose ----","info":"","x":490,"y":720,"wires":[]},{"id":"6f21dae0.c1a004","type":"json","z":"e9cabb74.fe91","name":"","property":"payload","action":"","pretty":false,"x":770,"y":960,"wires":[["36b406e4.ae51c2"]]},{"id":"b0cb9f93.2caeb","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.json","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":960,"wires":[["6f21dae0.c1a004"]]},{"id":"4b33e1a0.61c46","type":"http in","z":"e9cabb74.fe91","name":"","url":"preview","method":"post","upload":false,"swaggerDoc":"","x":180,"y":1080,"wires":[["1c459b29.13510d","446ac784.bea528"]]},{"id":"3332ecd0.f45074","type":"http response","z":"e9cabb74.fe91","name":"","statusCode":"200","headers":{"content-type":"application/pdf"},"x":1380,"y":1180,"wires":[]},{"id":"cf7f19e1.8049","type":"comment","z":"e9cabb74.fe91","name":"----------------------------------------------------- Serve HTML ressource  --------------------------------------------------","info":"","x":520,"y":1740,"wires":[]},{"id":"c9c60617.15294","type":"http in","z":"e9cabb74.fe91","name":"","url":"/corpo_message","method":"post","upload":false,"swaggerDoc":"","x":260,"y":1800,"wires":[["4f2a785d.585238","e07d5271.23d1c8"]],"info":"Example: http://127.0.0.1:1880/pod/render/site/dashboard\n\n/:solution/:verb/:template/:section\n\nMaps to\nmsg.req.params.solution\nmsg.req.params.verb\nmsg.req.params.template\nmsg.req.params.section"},{"id":"29708e21.496f12","type":"http response","z":"e9cabb74.fe91","name":"","statusCode":"200","headers":{"content-type":"text/html"},"x":1500,"y":1900,"wires":[]},{"id":"a01749c7.bcb838","type":"http in","z":"e9cabb74.fe91","name":"","url":"/get_editor","method":"post","upload":false,"swaggerDoc":"","x":240,"y":1940,"wires":[["67017b3f.474e6c"]],"info":"Example: http://127.0.0.1:1880/pod/render/site/dashboard\n\n/:solution/:verb/:template/:section\n\nMaps to\nmsg.req.params.solution\nmsg.req.params.verb\nmsg.req.params.template\nmsg.req.params.section"},{"id":"4fad8be4.967c14","type":"file in","z":"e9cabb74.fe91","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":650,"y":1940,"wires":[["29708e21.496f12"]]},{"id":"3a5372b6.95354e","type":"ui_template","z":"e9cabb74.fe91","group":"793172d6.403c04","name":"","order":0,"width":0,"height":0,"format":"<img width=\"300px\" src=\"{{msg.payload}}\" />","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1120,"y":660,"wires":[[]]},{"id":"f586aea4.ec4ca8","type":"function","z":"e9cabb74.fe91","name":"data -> payload","func":"msg.payload = msg.payload.data;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":760,"wires":[["2ab6e06b.8d40c"]]},{"id":"c833df11.d3bff8","type":"function","z":"e9cabb74.fe91","name":"IPv4 address","func":"// look up for the first IP v4 address\n\nfor (i = 0; i < msg.payload.networkInterfaces.Ethernet.length; i++) {\n    if (msg.payload.networkInterfaces.Ethernet[i].family == 'IPv4') {\n        msg.payload = msg.payload.networkInterfaces.Ethernet[i].address;\n        break;\n    }\n} \nmsg.topic = \"interface\";\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1780,"wires":[["a1e88745.b1207"]]},{"id":"3bcfc563.c8143a","type":"OS","z":"51790cbc.40d12c","name":"","x":750,"y":660,"wires":[["5f455144.bc0f08","f4763abf.8cb18","cd57bfe5.65992","294ace08.867382"]]},{"id":"2233cb65.66d92c","type":"Uptime","z":"51790cbc.40d12c","name":"","x":761,"y":615,"wires":[["cf9df36a.57f2"]]},{"id":"f6cd8807.f07de8","type":"CPUs","z":"51790cbc.40d12c","name":"","x":430,"y":100,"wires":[["ec2219ac.163db8"]]},{"id":"541ad389.27c8fc","type":"Memory","z":"51790cbc.40d12c","name":"","x":820,"y":260,"wires":[["369ef251.d4b55e","de59b3ca.dd8dc8","ac3731e3.7a7948","379f5c7f.1e2964"]]},{"id":"a69a6d00.74a27","type":"inject","z":"51790cbc.40d12c","name":"update","topic":"","payload":"","payloadType":"date","repeat":"30","crontab":"","once":true,"onceDelay":"","x":94,"y":245,"wires":[["3bcfc563.c8143a","2233cb65.66d92c","f6cd8807.f07de8","541ad389.27c8fc"]]},{"id":"369ef251.d4b55e","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.memusage;\nreturn msg;","outputs":1,"noerr":0,"x":825,"y":428,"wires":[["3d09a3d7.88d964"]]},{"id":"3d09a3d7.88d964","type":"ui_gauge","z":"51790cbc.40d12c","name":"Memory Usage","group":"8378d78.5c46728","order":2,"width":0,"height":0,"gtype":"gage","title":"1 Minute","label":"Usage","format":"{{value | number:2}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"x":1009,"y":432,"wires":[]},{"id":"de59b3ca.dd8dc8","type":"function","z":"51790cbc.40d12c","name":"","func":"function formatBytes(bytes,decimals) {\n   if(bytes === 0) return '0 Byte';\n   var k = 1000; // or 1024 for binary\n   var dm = decimals + 1 || 3;\n   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n   var i = Math.floor(Math.log(bytes) / Math.log(k));\n   return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];\n}\n\nmsg.payload = formatBytes(msg.payload.totalmem);\nreturn msg;","outputs":1,"noerr":0,"x":827,"y":471,"wires":[["c631b09d.f27ce"]]},{"id":"ac3731e3.7a7948","type":"function","z":"51790cbc.40d12c","name":"","func":"function formatBytes(bytes,decimals) {\n   if(bytes === 0) return '0 Byte';\n   var k = 1000; // or 1024 for binary\n   var dm = decimals + 1 || 3;\n   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n   var i = Math.floor(Math.log(bytes) / Math.log(k));\n   return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];\n}\n\nmsg.payload = formatBytes(msg.payload.freemem);\nreturn msg;","outputs":1,"noerr":0,"x":825,"y":517,"wires":[["2726425a.e48c9e"]]},{"id":"c631b09d.f27ce","type":"ui_text","z":"51790cbc.40d12c","group":"8378d78.5c46728","order":3,"width":0,"height":0,"name":"","label":"Total Memory","format":"{{msg.payload}}","layout":"row-spread","x":1008,"y":475,"wires":[]},{"id":"2726425a.e48c9e","type":"ui_text","z":"51790cbc.40d12c","group":"8378d78.5c46728","order":4,"width":0,"height":0,"name":"","label":"Free Memory","format":"{{msg.payload}}","layout":"row-spread","x":1012,"y":518,"wires":[]},{"id":"cf9df36a.57f2","type":"function","z":"51790cbc.40d12c","name":"","func":"function timeConversion(millisec) {\n\n    var seconds = (millisec / 1000).toFixed(1);\n\n    var minutes = (millisec / (1000 * 60)).toFixed(1);\n\n    var hours = (millisec / (1000 * 60 * 60)).toFixed(1);\n\n    var days = (millisec / (1000 * 60 * 60 * 24)).toFixed(1);\n\n    if (seconds < 60) {\n        return seconds + \" Sec\";\n    } else if (minutes < 60) {\n        return minutes + \" Min\";\n    } else if (hours < 24) {\n        return hours + \" Hrs\";\n    } else {\n        return days + \" Days\"\n    }\n}\n\nmsg.payload = timeConversion(msg.payload.uptime * 1000);\nreturn msg;","outputs":1,"noerr":0,"x":922,"y":615,"wires":[["dbdf60f6.459118"]]},{"id":"dbdf60f6.459118","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":1,"width":0,"height":0,"name":"","label":"Uptime","format":"{{msg.payload}}","layout":"row-spread","x":1077,"y":614,"wires":[]},{"id":"5f455144.bc0f08","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.hostname;\nreturn msg;","outputs":1,"noerr":0,"x":921,"y":652,"wires":[["813ae4b.05c0598"]]},{"id":"813ae4b.05c0598","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":2,"width":0,"height":0,"name":"","label":"Hostname","format":"{{msg.payload}}","layout":"row-spread","x":1089,"y":654,"wires":[]},{"id":"f4763abf.8cb18","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.platform;\nreturn msg;","outputs":1,"noerr":0,"x":923,"y":690,"wires":[["deb09153.6bed28"]]},{"id":"deb09153.6bed28","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":3,"width":0,"height":0,"name":"","label":"Platform","format":"{{msg.payload}}","layout":"row-spread","x":1085,"y":693,"wires":[]},{"id":"cd57bfe5.65992","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.arch;\nreturn msg;","outputs":1,"noerr":0,"x":924,"y":729,"wires":[["4a90764e.16b9"]]},{"id":"4a90764e.16b9","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":4,"width":0,"height":0,"name":"","label":"Arch","format":"{{msg.payload}}","layout":"row-spread","x":1073,"y":733,"wires":[]},{"id":"294ace08.867382","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.release;\nreturn msg;","outputs":1,"noerr":0,"x":925,"y":765,"wires":[["94523c4.a7e5c4"]]},{"id":"94523c4.a7e5c4","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":5,"width":0,"height":0,"name":"","label":"Release","format":"{{msg.payload}}","layout":"row-spread","x":1085,"y":771,"wires":[]},{"id":"ec2219ac.163db8","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.cpus[0].model;\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":100,"wires":[["c158cb18.d3bd5"]]},{"id":"c158cb18.d3bd5","type":"ui_text","z":"51790cbc.40d12c","group":"56329cc.047c7e4","order":6,"width":0,"height":0,"name":"","label":"CPU 1","format":"{{msg.payload}}","layout":"row-spread","x":710,"y":100,"wires":[]},{"id":"379f5c7f.1e2964","type":"function","z":"51790cbc.40d12c","name":"","func":"msg.payload = msg.payload.memusage;\nreturn msg;","outputs":1,"noerr":0,"x":822,"y":389,"wires":[["8189b1a7.25d3e"]]},{"id":"8189b1a7.25d3e","type":"ui_chart","z":"51790cbc.40d12c","name":"Memory - 24 Hours","group":"8378d78.5c46728","order":1,"width":0,"height":0,"label":"24 Hours","chartType":"line","legend":"false","xformat":"%H:%M:%S","interpolate":"linear","nodata":"","ymin":"","ymax":"","removeOlder":1,"removeOlderUnit":"86400","outputs":1,"x":1020,"y":392,"wires":[[]]},{"id":"a0ddd1aa.eeb3e","type":"comment","z":"51790cbc.40d12c","name":"Memory Usage","info":"","x":1005,"y":342,"wires":[]},{"id":"a4084b2.5cd3a38","type":"comment","z":"51790cbc.40d12c","name":"System Information","info":"","x":790,"y":560,"wires":[]},{"id":"e07d5271.23d1c8","type":"OS","z":"e9cabb74.fe91","name":"","x":470,"y":1820,"wires":[["643b3a0e.bb7c0c"]]},{"id":"643b3a0e.bb7c0c","type":"function","z":"e9cabb74.fe91","name":"hostname","func":"msg.payload = msg.payload.hostname;\nmsg.topic = \"host\";\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":1820,"wires":[["a1e88745.b1207"]]},{"id":"a1e88745.b1207","type":"join","z":"e9cabb74.fe91","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":850,"y":1800,"wires":[["58366c4d.df29ec"]]},{"id":"4f2a785d.585238","type":"NetworkIntf","z":"e9cabb74.fe91","name":"","x":490,"y":1780,"wires":[["c833df11.d3bff8"]]},{"id":"58366c4d.df29ec","type":"template","z":"e9cabb74.fe91","name":"Corpo Message","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<body>\n\n<h1>OL Connect Server ({{payload.host}})</h1>\n    <p>\n    IP Address : {{payload.interface}} !\n    </p>\n</body>\n</html>","output":"str","x":1020,"y":1800,"wires":[["29708e21.496f12"]]},{"id":"9c8e0791.7a0e38","type":"ping","z":"51790cbc.40d12c","name":"google","host":"8.8.8.8","timer":"60","x":350,"y":1060,"wires":[["3f33b54e.8662ca"]]},{"id":"3f33b54e.8662ca","type":"ui_chart","z":"51790cbc.40d12c","name":"","group":"24ff660a.29feda","order":1,"width":0,"height":0,"label":"Ping time","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":520,"y":1060,"wires":[[]]},{"id":"36b406e4.ae51c2","type":"debug","z":"e9cabb74.fe91","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":910,"y":960,"wires":[]},{"id":"345bf2b.987a70e","type":"mongodb-node","z":"8fb980b3.1d7608","mongodb":"676f881a.2970e","name":"store","collection":"gemalto","operation":"insert","upsert":false,"multi":false,"x":730,"y":280,"wires":[["732d5dd8.149f6c"]]},{"id":"5cd75285.598de4","type":"mongodb-node","z":"8fb980b3.1d7608","mongodb":"676f881a.2970e","name":"retrieve","collection":"gemalto","operation":"find","upsert":false,"multi":false,"x":740,"y":320,"wires":[["732d5dd8.149f6c"]]},{"id":"cf99bd7.f33f8c","type":"http in","z":"8fb980b3.1d7608","name":"web request","url":"/test/:uid/:action","method":"get","upload":false,"swaggerDoc":"","x":150,"y":320,"wires":[["1d7b3879.c23e6"]]},{"id":"732d5dd8.149f6c","type":"http response","z":"8fb980b3.1d7608","name":"Return","statusCode":"","headers":{},"x":930,"y":300,"wires":[]},{"id":"dbacaf29.9c5ce8","type":"function","z":"8fb980b3.1d7608","name":"Set value to store","func":"var value = msg.payload.value;\nmsg.payload = msg.req.params;\nmsg.payload.value = value;\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":280,"wires":[["345bf2b.987a70e"]]},{"id":"1d7b3879.c23e6","type":"switch","z":"8fb980b3.1d7608","name":"","property":"req.params.action","propertyType":"msg","rules":[{"t":"eq","v":"store","vt":"str"},{"t":"eq","v":"retrieve","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":320,"wires":[["dbacaf29.9c5ce8"],["d86cf27a.9a5d38"]]},{"id":"d86cf27a.9a5d38","type":"function","z":"8fb980b3.1d7608","name":"set message","func":"msg.payload = { \"uid\" : msg.req.params.uid};\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":320,"wires":[["5cd75285.598de4"]]},{"id":"eacec356.94c3c8","type":"comment","z":"8fb980b3.1d7608","name":"Mongo DB test","info":"","x":200,"y":240,"wires":[]},{"id":"1c459b29.13510d","type":"function","z":"e9cabb74.fe91","name":"filter message","func":"if ( flow.get('debug')) {\n    return msg;\n} else {\n    return;\n}\n","outputs":1,"noerr":0,"x":440,"y":960,"wires":[["b0cb9f93.2caeb"]]},{"id":"8f7cbca8.a87d9","type":"function","z":"e9cabb74.fe91","name":"set variable for image preview","func":"msg.page = msg.payload.page;\nmsg.format = 'png';\nmsg.topic = 'refreshback';\nmsg.bank = msg.payload.bank;\nmsg.filename = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.payload.templateName + '/small.json';\nmsg.template = encodeURIComponent(msg.bank + msg.payload.templateName+'.ol-template');\nreturn msg;\n","outputs":1,"noerr":0,"x":510,"y":560,"wires":[["af602628.d670c"]]},{"id":"89a4b04d.15d238","type":"change","z":"e9cabb74.fe91","name":"WPdata and preserve payload","rules":[{"t":"set","p":"WPdata","pt":"msg","to":"payload.json","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.json","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":480,"wires":[["5fd844ba.eed01c"]]},{"id":"5fd844ba.eed01c","type":"json","z":"e9cabb74.fe91","name":"WPdata parse","property":"payload","action":"","pretty":false,"x":460,"y":520,"wires":[["8f7cbca8.a87d9"]]},{"id":"af602628.d670c","type":"file in","z":"e9cabb74.fe91","name":"load small data file","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":470,"y":600,"wires":[["629bfb1a.2e99a4"]]},{"id":"629bfb1a.2e99a4","type":"json","z":"e9cabb74.fe91","name":"parse datafile","property":"payload","action":"","pretty":false,"x":460,"y":640,"wires":[["c8ffbf46.20557"]]},{"id":"c8ffbf46.20557","type":"function","z":"e9cabb74.fe91","name":"inject WPdata in record","func":"msg.payload = {data: msg.payload, pages: msg.page, format: msg.format};\nmsg.payload.data.WPdata = msg.WPdata;\nreturn msg;\n","outputs":1,"noerr":0,"x":490,"y":680,"wires":[["f586aea4.ec4ca8","6e4db292.5c1a44"]]},{"id":"9b3a75ec.7f3e18","type":"function","z":"e9cabb74.fe91","name":"set variables for preview","func":"msg.topic = 'preview';\nmsg.bank = msg.payload.bank;\nmsg.filename = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.payload.templateName + '/big.json';\nmsg.template = encodeURIComponent(msg.bank + msg.payload.templateName+'.ol-template');\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":1140,"wires":[["96fce900.6772b"]]},{"id":"446ac784.bea528","type":"change","z":"e9cabb74.fe91","name":"WPdata and preserve payload","rules":[{"t":"set","p":"WPdata","pt":"msg","to":"payload.json","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.json","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1060,"wires":[["9a433ce5.f86ad"]]},{"id":"9a433ce5.f86ad","type":"json","z":"e9cabb74.fe91","name":"WPdata parse","property":"payload","action":"","pretty":false,"x":440,"y":1100,"wires":[["9b3a75ec.7f3e18"]]},{"id":"96fce900.6772b","type":"file in","z":"e9cabb74.fe91","name":"load large data file","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":450,"y":1180,"wires":[["e7f9c550.b61838"]]},{"id":"e7f9c550.b61838","type":"json","z":"e9cabb74.fe91","name":"parse datafile","property":"payload","action":"","pretty":false,"x":440,"y":1220,"wires":[["cf8e5c89.fa359"]]},{"id":"cf8e5c89.fa359","type":"function","z":"e9cabb74.fe91","name":"set more variables","func":"\n//move payload into data\nmsg.payload = {data : msg.payload};\n// insert WPdata payload in the data\n\nif (Array.isArray(msg.payload.data)) {\nfor (i = 0; i < msg.payload.data.length; i++) {\n        msg.payload.data[i].WPdata = msg.WPdata;\n    }   \n} else {\n    msg.payload.data.WPdata = msg.WPdata;\n}\nmsg.jobinfos = {template : msg.template};\nreturn msg;\n","outputs":1,"noerr":0,"x":450,"y":1260,"wires":[["89277eba.d36d58"]]},{"id":"e5eb87aa.3ddb8","type":"olc-create-job","z":"e9cabb74.fe91","server":"ba23399f.6256c8","jobpreset":"default.OL-jobpreset","name":"","x":770,"y":1180,"wires":[["5ddf23e4.5b8cfc"]]},{"id":"5ddf23e4.5b8cfc","type":"olc-create-output","z":"e9cabb74.fe91","server":"ba23399f.6256c8","outputpreset":"default.OL-outputpreset","name":"","x":780,"y":1220,"wires":[["7497cf77.f2ad68"]]},{"id":"89277eba.d36d58","type":"http request","z":"e9cabb74.fe91","name":"Connect content creation","method":"POST","ret":"bin","paytoqs":false,"url":"http://localhost:9340/rest/serverengine/workflow/contentcreation/{{{template}}}","tls":"","persist":false,"proxy":"","authType":"basic","x":810,"y":1060,"wires":[["89b44d2a.4def48"]]},{"id":"3219b803.33c3d8","type":"http request","z":"e9cabb74.fe91","name":"get results","method":"POST","ret":"bin","paytoqs":false,"url":"http://localhost:9340/rest/serverengine/workflow/contentcreation/getResult/{{{operationId}}}","tls":"","persist":false,"proxy":"","authType":"basic","x":770,"y":1140,"wires":[["e5eb87aa.3ddb8"]]},{"id":"89b44d2a.4def48","type":"function","z":"e9cabb74.fe91","name":"operationid in headers","func":"msg.operationId = msg.headers.operationid;\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":1100,"wires":[["3219b803.33c3d8"]]},{"id":"87a0012b.256b7","type":"file in","z":"e9cabb74.fe91","name":"load pdf","filename":"","format":"","chunk":false,"sendError":false,"encoding":"utf8","x":1080,"y":1100,"wires":[["7dacccfd.fd6e1c"]]},{"id":"7497cf77.f2ad68","type":"change","z":"e9cabb74.fe91","name":"Set Filename","rules":[{"t":"set","p":"filename","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":1060,"wires":[["87a0012b.256b7"]]},{"id":"7dacccfd.fd6e1c","type":"base64","z":"e9cabb74.fe91","name":"convert to base 64","action":"","property":"payload","x":1110,"y":1140,"wires":[["54874bfa.4ab414"]]},{"id":"54874bfa.4ab414","type":"function","z":"e9cabb74.fe91","name":"prepend application/pdf","func":"msg.payload = \"data:application/pdf;base64,\" + msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":1180,"wires":[["3332ecd0.f45074"]]},{"id":"2c5984d5.4c688c","type":"template","z":"e9cabb74.fe91","name":"Drag and drop","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<body>\n<p>test</p>\n<div id=\"drop-area\">\n\t<form class=\"my-form\" method=\"post\" enctype=\"multipart/form-data\">\n\t\t<p>Upload files with the file dialog or by dragging and dropping template, datamap, data file (JSON, MAI) onto the dashed region</p>\n  \t\t<input type=\"hidden\" name=\"ted_upload_action\" value=\"upload\">\n\t\t<input type=\"file\" id=\"ted_upload\" name=\"ted_upload\" accept=\".ol-template,.ol-datamapper,.mai,.json,.data\">\n\t\t<a class=\"button\"><label class=\"button\" for=\"ted_upload\">Select files</label></a>\n  \t\t<button id=\"upload_submit\" type=\"submit\">\".__('Upload','theme').\"</button>\n\t</form>\n</div>\n</body>\n","output":"str","x":460,"y":1880,"wires":[["29708e21.496f12"]]},{"id":"318bef23.160f08","type":"http in","z":"e9cabb74.fe91","name":"","url":"/ted_drop","method":"post","upload":false,"swaggerDoc":"","x":240,"y":1880,"wires":[["2c5984d5.4c688c"]],"info":"Example: http://127.0.0.1:1880/pod/render/site/dashboard\n\n/:solution/:verb/:template/:section\n\nMaps to\nmsg.req.params.solution\nmsg.req.params.verb\nmsg.req.params.template\nmsg.req.params.section"},{"id":"cb48c9b5.647bf","type":"http in","z":"e9cabb74.fe91","name":"","url":"/upload","method":"post","upload":false,"swaggerDoc":"","x":230,"y":2060,"wires":[["33a78e30.911192","4a8d401.76af0c"]],"info":"Example: http://127.0.0.1:1880/pod/render/site/dashboard\n\n/:solution/:verb/:template/:section\n\nMaps to\nmsg.req.params.solution\nmsg.req.params.verb\nmsg.req.params.template\nmsg.req.params.section"},{"id":"a6abf67f.c75178","type":"http request","z":"e9cabb74.fe91","name":"","method":"GET","ret":"bin","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":230,"y":2160,"wires":[["94ba04f.1a8f278"]]},{"id":"33a78e30.911192","type":"function","z":"e9cabb74.fe91","name":"set url","func":"var msg1 ={\n    url: msg.payload.url,\n    type: msg.payload.type,\n    original_name: msg.payload.original_name,\n    size: msg.payload.size,\n    bank: msg.payload.bank\n}\nreturn msg1;","outputs":1,"noerr":0,"x":210,"y":2120,"wires":[["a6abf67f.c75178"]]},{"id":"94ba04f.1a8f278","type":"function","z":"e9cabb74.fe91","name":"Get Extension","func":"// Extract the file extension and name of the resource.\nmsg.file = encodeURIComponent( msg.original_name );\nmsg.ext = msg.original_name.split('.').pop(); // extract ext from filename\ndelete msg.url; // use the one in the next node\n\nnode.status({fill:\"blue\",shape:\"dot\",text: msg.ext });\n\nswitch(msg.ext.toLowerCase())\n{\n    case 'data':\n    case 'json':\n    case 'mai':\n        msg.filename = flow.get(\"dataPath\") + '/'+ msg.bank + '/' + msg.original_name;\n        return [ msg, null, null, null];\n    case 'ol-datamapper':\n         msg.path = 'DataMiningConfig';\n        return [ null, msg, null, null];\n    case 'ol-template':\n         msg.path = 'template';\n        msg.filename = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.original_name;\n        return [ null, null, msg, null];\n    case 'zip':\n        return [ null, null, null, msg];\n    default:\n        return;\n}\n","outputs":4,"noerr":0,"x":240,"y":2220,"wires":[[],[],[],["ec8ca358.bfe0d8"]]},{"id":"726c1ca.1d3ffe4","type":"comment","z":"e9cabb74.fe91","name":"---------- WP drop resources to the Connect File Store ----------------------------","info":"asdfasdf","x":430,"y":2000,"wires":[]},{"id":"4a8d401.76af0c","type":"function","z":"e9cabb74.fe91","name":"OK","func":"msg.payload = 'OK';\nreturn msg;\n","outputs":1,"noerr":0,"x":850,"y":2020,"wires":[["29708e21.496f12"]]},{"id":"477d3331.3a70cc","type":"comment","z":"8fb980b3.1d7608","name":"Aggregator pattern","info":"","x":290,"y":480,"wires":[]},{"id":"4d39c492.c365cc","type":"function","z":"8fb980b3.1d7608","name":"payload=451","func":"msg.payload = 451;\n\nreturn msg;","outputs":1,"noerr":0,"x":573.8332901000977,"y":563.5001125335693,"wires":[["5dff0249.9afc94"]]},{"id":"5dff0249.9afc94","type":"function","z":"8fb980b3.1d7608","name":"Calculate Sum","func":"// Reduce the number of inputs\ncontext.global.n--;\n\n// Store the data in msg.payload for all operations as they complete\ncontext.global.data[context.global.n] = msg.payload;\n\n// When all operations are complete calculate the sum and return\nif (context.global.n === 0)\n{   // Calculate the total value\n    var sum = 0;\n    for (var i = 0; i < context.global.data.length; i++)\n    {\n        sum += context.global.data[i];\n    }\n    msg.payload = sum;\n\n    return msg;\n}","outputs":1,"noerr":0,"x":768.8333435058594,"y":586.5001354217529,"wires":[["f851ce0.50851b"]]},{"id":"c4d48f17.af0f3","type":"function","z":"8fb980b3.1d7608","name":"payload=326","func":"msg.payload = 326;\n\nreturn msg;","outputs":1,"noerr":0,"x":572.8333129882812,"y":611.5001249313354,"wires":[["5dff0249.9afc94"]]},{"id":"f851ce0.50851b","type":"debug","z":"8fb980b3.1d7608","name":"Returns 777","active":true,"console":"false","complete":"payload","x":950.8333206176758,"y":586.5001230239868,"wires":[]},{"id":"bbc5bc34.7e1168","type":"function","z":"8fb980b3.1d7608","name":"Combine 2 Functions","func":"context.global.n = 2;\ncontext.global.data = new Array(2);\n\nreturn msg;","outputs":1,"noerr":0,"x":369.83331298828125,"y":588.5001220703125,"wires":[["4d39c492.c365cc","c4d48f17.af0f3"]]},{"id":"bb21407b.a9bc1","type":"comment","z":"8fb980b3.1d7608","name":"↓ 1st value","info":"","x":572.5798034667969,"y":525.0741882324219,"wires":[]},{"id":"de6e9bf2.5897a","type":"inject","z":"8fb980b3.1d7608","name":"Calculate the sum of 2 numbers","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":329.8893585205078,"y":524.1932220458984,"wires":[["bbc5bc34.7e1168"]]},{"id":"df417d2e.352dd8","type":"comment","z":"8fb980b3.1d7608","name":"↑ 2nd value","info":"","x":571.4131546020508,"y":652.0741004943848,"wires":[]},{"id":"901895c.9980fe8","type":"comment","z":"8fb980b3.1d7608","name":"Define how many parallel operations ↑","info":"","x":319.3417053222656,"y":631.62158203125,"wires":[]},{"id":"82baabd6.32ac28","type":"comment","z":"8fb980b3.1d7608","name":"↑ Once all parallel operations complete, calculate sum","info":"","x":855.9132080078125,"y":628.907470703125,"wires":[]},{"id":"93660c35.66da68","type":"http response","z":"e9cabb74.fe91","name":"200 application/json","statusCode":"200","headers":{"content-type":"application/json"},"x":1400,"y":1560,"wires":[]},{"id":"198cd36.03b162d","type":"config","z":"e9cabb74.fe91","name":"Alienware config","properties":[{"p":"dataPath","pt":"flow","to":"C:/node/data","tot":"str"},{"p":"server","pt":"flow","to":"Alienware","tot":"str"},{"p":"resourcePath","pt":"flow","to":"C:\\wamp64\\www\\gemalto\\wp-content\\themes\\Document-Assembly","tot":"str"},{"p":"filestore","pt":"flow","to":"C:\\Users\\monsi\\Connect\\filestore\\","tot":"str"},{"p":"templatePath","pt":"flow","to":"c:/node/original-template","tot":"str"}],"active":true,"x":900,"y":100,"wires":[]},{"id":"4956511c.0426c8","type":"config","z":"e9cabb74.fe91","name":"Azure config","properties":[{"p":"dataPath","pt":"flow","to":"G:/node/data","tot":"str"},{"p":"server","pt":"flow","to":"azure","tot":"str"},{"p":"resourcePath","pt":"flow","to":"G:/Gemalto/red/Document-Assembly","tot":"str"},{"p":"filestore","pt":"flow","to":"C:\\Users\\monsi\\Connect\\filestore\\workflow\\template","tot":"str"},{"p":"templatePath","pt":"flow","to":"G/node/original-template","tot":"str"}],"active":true,"x":890,"y":220,"wires":[]},{"id":"9294d66e.de8f1","type":"inject","z":"e9cabb74.fe91","name":"On startup","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":190,"y":120,"wires":[["5892b00c.848bd8"]]},{"id":"4980601f.df92b","type":"comment","z":"e9cabb74.fe91","name":"-------------------------------------------- Initialize a few flow variable depending on server we are running on ---------------------------------------------------------","info":"","x":600,"y":40,"wires":[]},{"id":"5892b00c.848bd8","type":"OS","z":"e9cabb74.fe91","name":"","x":350,"y":120,"wires":[["5175132e.a9ebec"]]},{"id":"5175132e.a9ebec","type":"switch","z":"e9cabb74.fe91","name":"switch on hostname","property":"payload.hostname","propertyType":"msg","rules":[{"t":"eq","v":"Alienware","vt":"str"},{"t":"eq","v":"olsaas1-olc1","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":560,"y":120,"wires":[["198cd36.03b162d","4411b274.aa5b84","c222e0be.421058"],["4956511c.0426c8","2d2f3f1b.6fac9","3d4875f3.f2a8e2"]]},{"id":"67017b3f.474e6c","type":"function","z":"e9cabb74.fe91","name":"filename -> templateEditor","func":"msg.filename = flow.get(\"resourcePath\") +'/templateEditor.html';\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":1940,"wires":[["4fad8be4.967c14"]]},{"id":"ec7de6d1.7660d","type":"http in","z":"e9cabb74.fe91","name":"","url":"/template","method":"get","upload":false,"swaggerDoc":"","x":230,"y":1500,"wires":[["2ee9e32f.0d9c34"]]},{"id":"bc79ddfa.159cd","type":"comment","z":"e9cabb74.fe91","name":"-------------- get a specific template structure in JSON","info":"","x":350,"y":1460,"wires":[]},{"id":"4411b274.aa5b84","type":"file in","z":"e9cabb74.fe91","name":"","filename":"C:\\wamp64\\www\\gemalto\\wp-content\\themes\\Document-Assembly\\TED payload.js","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1090,"y":140,"wires":[["c97401c4.81b598"]]},{"id":"c97401c4.81b598","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"tedPayload","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":140,"wires":[[]]},{"id":"c222e0be.421058","type":"file in","z":"e9cabb74.fe91","name":"","filename":"C:\\wamp64\\www\\gemalto\\wp-content\\themes\\Document-Assembly\\TED condition.js","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1090,"y":180,"wires":[["2fd16aa2.dedc56"]]},{"id":"2fd16aa2.dedc56","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"tedCondition","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":180,"wires":[[]]},{"id":"2d2f3f1b.6fac9","type":"file in","z":"e9cabb74.fe91","name":"","filename":"G:/Gemalto/red/Document-Assembly/TED payload.js","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1000,"y":260,"wires":[["fd6b3d97.c816"]]},{"id":"fd6b3d97.c816","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"tedPayload","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":260,"wires":[[]]},{"id":"3d4875f3.f2a8e2","type":"file in","z":"e9cabb74.fe91","name":"","filename":"G:/Gemalto/red/Document-Assembly/TED condition.js","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1000,"y":300,"wires":[["6a9ca296.d71bf4"]]},{"id":"6a9ca296.d71bf4","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"tedCondition","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":300,"wires":[[]]},{"id":"f198a0d0.822b68","type":"comment","z":"e9cabb74.fe91","name":"Assume that all will be OK","info":"","x":1130,"y":1980,"wires":[]},{"id":"a591353c.7c956","type":"fs-ops-dir","z":"8fb980b3.1d7608","name":"","path":"c:\\red","pathType":"str","filter":"*","filterType":"str","dir":"files","dirType":"msg","x":380,"y":860,"wires":[["61a44829.7e4388"]]},{"id":"3e7c43f9.c4feb4","type":"inject","z":"8fb980b3.1d7608","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":860,"wires":[["a591353c.7c956"]]},{"id":"61a44829.7e4388","type":"debug","z":"8fb980b3.1d7608","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":860,"wires":[]},{"id":"ab0049e8.3b4708","type":"ui_switch","z":"51790cbc.40d12c","name":"","label":"Swirth Debug message","tooltip":"","group":"eca3b0d4.5b7868","order":0,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"switch","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":350,"y":900,"wires":[["dca8165a.4185c"]]},{"id":"dca8165a.4185c","type":"function","z":"51790cbc.40d12c","name":"state","func":"var state = flow.get('debug') || false;\n\nif (msg.topic == 'switch') {\n    flow.set('debug', msg.payload);\n} \n\nmsg.payload = 'Debugging message is ' + (state ? 'on':'off');\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":900,"wires":[["4200e619.a2fe2"]]},{"id":"4200e619.a2fe2","type":"debug","z":"51790cbc.40d12c","name":"state","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":710,"y":900,"wires":[]},{"id":"41318030.86f1a","type":"inject","z":"51790cbc.40d12c","name":"on","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":true,"onceDelay":"0.1","x":150,"y":860,"wires":[["ab0049e8.3b4708"]]},{"id":"fb7bdb90.0937f","type":"inject","z":"51790cbc.40d12c","name":"off","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":"","x":150,"y":920,"wires":[["ab0049e8.3b4708"]]},{"id":"b054fba2.91f6b8","type":"comment","z":"51790cbc.40d12c","name":"----------------------------------------------------- Dashboard ----------------------------------------------","info":"","x":400,"y":800,"wires":[]},{"id":"65980169.bcd8c","type":"file","z":"e9cabb74.fe91","name":"write file","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":260,"y":2500,"wires":[["580728e0.7f644"]]},{"id":"f8bd9a1.1fa2968","type":"debug","z":"e9cabb74.fe91","name":"Error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1620,"y":2600,"wires":[]},{"id":"6b2ee1c.4031da","type":"zip","z":"e9cabb74.fe91","name":"unzip","mode":"decompress","filename":"","outasstring":false,"x":210,"y":2340,"wires":[["1f7475cb.45f512"]]},{"id":"1f7475cb.45f512","type":"split","z":"e9cabb74.fe91","name":"for each","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":220,"y":2420,"wires":[["e5b90c90.b6e448"]]},{"id":"e5b90c90.b6e448","type":"function","z":"e9cabb74.fe91","name":"set filename","func":"msg.filename = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.original_name + '/' + msg.payload.filename;\nmsg.file = msg.payload.filename; // keep filename for the join\nmsg.payload = msg.payload.payload;\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":2460,"wires":[["65980169.bcd8c"]]},{"id":"a671806.459fb8","type":"join","z":"e9cabb74.fe91","name":"return array of file written","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":270,"y":2580,"wires":[["b167f911.45c628"]]},{"id":"580728e0.7f644","type":"function","z":"e9cabb74.fe91","name":"filename -> payload","func":"msg.payload = msg.filename;\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":2540,"wires":[["a671806.459fb8"]]},{"id":"b167f911.45c628","type":"function","z":"e9cabb74.fe91","name":"setup & we have necessary parts?","func":"// input is array of filenames in random order\n// one must be template and one a datamap\n\nvar datamap, template;\n\nfor (var i=0; i<msg.payload.length;i++) {\n    if (msg.payload[i].split('.').pop().toLowerCase() == 'ol-datamapper') {\n        datamap = msg.payload[i];\n    } else\n    if (msg.payload[i].split('.').pop().toLowerCase() == 'ol-template') {\n        template = msg.payload[i];\n    }\n}\n\nif ( datamap && template ) {\n    msg.datamapFilename =datamap;\n    msg.templateFilename = template;\n    msg.indexFilename = msg.path + 'index.json';\n    msg.testPdfFilename = msg.path + 'sample.pdf';\n    msg.dataFilename = msg.path + 'original.data';\n    msg.datamap = encodeURIComponent(msg.bank + msg.original_name + '.OL-datamapper');\n    msg.template = encodeURIComponent(msg.bank + msg.original_name + '.OL-template');\n    msg.data = encodeURIComponent(msg.bank + msg.original_name + '.data');    \n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":300,"y":2620,"wires":[["1838a8c7.2896ff"],["6cd9318b.dd8308"]]},{"id":"ec8ca358.bfe0d8","type":"function","z":"e9cabb74.fe91","name":"remove .zip and set path","func":"msg.original_name = msg.original_name.slice(0,-4);\nmsg.path = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.original_name + '/';\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":2300,"wires":[["6b2ee1c.4031da"]]},{"id":"72de219f.2751e8","type":"file in","z":"e9cabb74.fe91","name":"load template file","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":1350,"y":2140,"wires":[["6475eae4.9466bc"]]},{"id":"1ad847d1.59f3f","type":"comment","z":"e9cabb74.fe91","name":"Save all files to folder","info":"","x":260,"y":2380,"wires":[]},{"id":"aeb255d8.9a29b","type":"http request","z":"e9cabb74.fe91","name":"Upload template to FileStore","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:9340/rest/serverengine/filestore/template?filename={{{template}}}&persistent=true","tls":"","persist":false,"proxy":"","authType":"basic","x":1380,"y":2560,"wires":[["bdaed9ef.0d5b3"]]},{"id":"bdaed9ef.0d5b3","type":"switch","z":"e9cabb74.fe91","name":"status code?","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"},{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":2600,"wires":[["2d026e37.56757a"],["b084ca08.0e5238"]]},{"id":"2d026e37.56757a","type":"template","z":"e9cabb74.fe91","name":"Error","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Error file store : {{payload}} !","output":"str","x":1490,"y":2600,"wires":[["f8bd9a1.1fa2968"]]},{"id":"c7d266e1.1166b8","type":"comment","z":"e9cabb74.fe91","name":"Hack the template file by injecting some script","info":"","x":1430,"y":2060,"wires":[]},{"id":"8bf65f47.8f67f8","type":"comment","z":"e9cabb74.fe91","name":"create sample data file in JSON","info":"","x":830,"y":2500,"wires":[]},{"id":"48ef3051.784ee","type":"debug","z":"e9cabb74.fe91","name":"Error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":380,"y":2680,"wires":[]},{"id":"f3c74787.e495c8","type":"change","z":"e9cabb74.fe91","name":"set template filename","rules":[{"t":"set","p":"filename","pt":"msg","to":"templateFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":2100,"wires":[["72de219f.2751e8"]]},{"id":"46a1ff46.478528","type":"http request","z":"e9cabb74.fe91","name":"Upload datamap to FileStore persitent","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:9340/rest/serverengine/filestore/DataMiningConfig?filename={{{datamap}}}&persistent=true","tls":"","persist":false,"proxy":"","authType":"basic","x":850,"y":2420,"wires":[["8eb26ba1.430148"]]},{"id":"8eb26ba1.430148","type":"switch","z":"e9cabb74.fe91","name":"status code?","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"},{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":2460,"wires":[["a8d1590b.829d38"],["1030f449.5fa6fc"]]},{"id":"a8d1590b.829d38","type":"template","z":"e9cabb74.fe91","name":"Error","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Error file store : {{payload}} !","output":"str","x":950,"y":2460,"wires":[["9854d99.7de92a8"]]},{"id":"9854d99.7de92a8","type":"debug","z":"e9cabb74.fe91","name":"Error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1080,"y":2460,"wires":[]},{"id":"1030f449.5fa6fc","type":"change","z":"e9cabb74.fe91","name":"set datamap filename and id","rules":[{"t":"set","p":"filename","pt":"msg","to":"dataFilename","tot":"msg"},{"t":"set","p":"req.params.id","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":2540,"wires":[["6bfd75b2.817214"]]},{"id":"4fd02093.e9eae","type":"file in","z":"e9cabb74.fe91","name":"load the .ol-datamap","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":800,"y":2380,"wires":[["46a1ff46.478528"]]},{"id":"1838a8c7.2896ff","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"filename","pt":"msg","to":"datamapFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":2100,"wires":[["1ddaaf89.e0d718"]]},{"id":"caacf6c3.bff858","type":"olc-retrieve-data-records","z":"e9cabb74.fe91","server":"ba23399f.6256c8","output":"values","name":"","x":810,"y":2620,"wires":[["d76e80fb.099728"]]},{"id":"6bfd75b2.817214","type":"olc-execute-data-mapping","z":"e9cabb74.fe91","server":"ba23399f.6256c8","dmconfig":"{{{id}}}","name":"","x":800,"y":2580,"wires":[["caacf6c3.bff858"]]},{"id":"a57675de.da1fb8","type":"file","z":"e9cabb74.fe91","name":"write single record json file","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1060,"y":2660,"wires":[["f3c74787.e495c8"]]},{"id":"681e26a9.09423","type":"file","z":"e9cabb74.fe91","name":"write all record json file","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":810,"y":2700,"wires":[[]]},{"id":"d76e80fb.099728","type":"function","z":"e9cabb74.fe91","name":"write JSON datafile","func":"// this one is for the writting of large.json\nvar msg1= {\n    payload: msg.payload, \n    filename: msg.path + 'big.json'\n};\n\n// while this is for small.json and rest of the process\nmsg.filename= msg.path + 'small.json';\nmsg.small = msg.payload[0]; // first record\nmsg.payload = msg.small; // continue with small\nreturn [msg,msg1];\n","outputs":2,"noerr":0,"x":790,"y":2660,"wires":[["a57675de.da1fb8"],["681e26a9.09423"]]},{"id":"3644f44f.ca32c4","type":"olc-create-preview-pdf","z":"e9cabb74.fe91","server":"ba23399f.6256c8","template":"{{{id}}}","name":"","x":1360,"y":2720,"wires":[["a24afcf1.e59ea"]]},{"id":"b084ca08.0e5238","type":"change","z":"e9cabb74.fe91","name":"set datamap filename and id","rules":[{"t":"set","p":"req.params.id","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"small","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1380,"y":2680,"wires":[["3644f44f.ca32c4"]]},{"id":"6475eae4.9466bc","type":"zip","z":"e9cabb74.fe91","name":"unzip","mode":"decompress","filename":"","outasstring":false,"x":1310,"y":2180,"wires":[["11e005ad.2aeb7a"]]},{"id":"11e005ad.2aeb7a","type":"function","z":"e9cabb74.fe91","name":"find index.xml","func":"\nmsg.zip = msg.payload; // keep the zip\nvar index = msg.payload.find(obj => obj.filename == 'index.xml');\nif (index) {\n    var b=Buffer.from(index.payload);\n    msg.payload = b.toString(); \n    return msg;\n} else {\n    return;\n}\n","outputs":1,"noerr":0,"x":1340,"y":2220,"wires":[["1ca5e7bb.fc148"]]},{"id":"1ca5e7bb.fc148","type":"xml","z":"e9cabb74.fe91","name":"xml -> json","property":"payload","attr":"","chr":"","x":1330,"y":2260,"wires":[["ddaeb3d0.e37538","d301d0f2.af344"]]},{"id":"ddaeb3d0.e37538","type":"function","z":"e9cabb74.fe91","name":"inject control script","func":"\n// find to see if the TED conditional is present\nvar script = msg.payload.package.scripts[0].script.find(obj => obj.name == 'TED conditional background');\n\n\n// if so replace the code by local one\nif (script) {\n    script.source = [flow.get('tedCondition')];\n} else {\n    msg.payload.package.scripts[0].script.unshift(\n        {\n            \"$\":{\"type\":\"STANDARD\"},\n            \"enabled\":[\"true\"],\n            \"findText\":[\"\"],\n            \"name\":[\"TED conditional background\"],\n            \"origin\":[\"\"],\n            \"selectorText\":[\"[section] body\"],\n            \"selectorType\":[\"QUERY\"],\n            \"source\":['WPdata = JSON.parse(record.fields.WPdata);\\n' + flow.get('tedCondition')]\n        }\n    );\n}\n\nscript = msg.payload.package.scripts[0].script.find(obj => obj.name == 'TED payload');\n\nif (script) {\n    script.source = ['WPdata = JSON.parse(record.fields.WPdata);\\n' + flow.get('tedPayload')];\n} else {\n    msg.payload.package.scripts[0].script.unshift(\n        {\n            \"$\": {\"type\": \"CONTROL\"},\n            \"enabled\": [\"true\"],\n            \"findText\": [\"\"],\n            \"name\": [\"TED payload\"],\n            \"origin\": [\"\"],\n            \"selectorText\": [\"\"],\n            \"selectorType\": [\"QUERY\"],\n            \"source\": ['WPdata = JSON.parse(record.fields.WPdata);\\n' + flow.get('tedPayload')]\n        }\n    );\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":2300,"wires":[["a8430044.c70fe8"]]},{"id":"a8430044.c70fe8","type":"xml","z":"e9cabb74.fe91","name":"json -> xml","property":"payload","attr":"","chr":"","x":1330,"y":2340,"wires":[["b2c83b71.089058"]]},{"id":"b2c83b71.089058","type":"function","z":"e9cabb74.fe91","name":"store index.xml","func":"\nvar index = msg.zip.find(obj => obj.filename == 'index.xml');\nif (index) {\n    index.payload = new Buffer(msg.payload);\n}\nmsg.payload = msg.zip;\ndelete msg.filename; // otherwise it confuse the zip plugin\nreturn msg;\n","outputs":1,"noerr":0,"x":1340,"y":2380,"wires":[["29cdd2be.072eae"]]},{"id":"29cdd2be.072eae","type":"zip","z":"e9cabb74.fe91","name":"zip","mode":"compress","filename":"","outasstring":false,"x":1310,"y":2420,"wires":[["d7b1e5ab.23fd7"]]},{"id":"a7439e28.ebb3b","type":"debug","z":"e9cabb74.fe91","name":"Error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1620,"y":2760,"wires":[]},{"id":"a24afcf1.e59ea","type":"switch","z":"e9cabb74.fe91","name":"status code?","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"},{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":2760,"wires":[["1de25641.d5940a"],["25cfc900.c8273"]]},{"id":"1de25641.d5940a","type":"template","z":"e9cabb74.fe91","name":"Error","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Error create test PDF : {{payload}} !","output":"str","x":1490,"y":2760,"wires":[["a7439e28.ebb3b"]]},{"id":"3b6c7a8f.e03d06","type":"debug","z":"e9cabb74.fe91","name":"Success","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1470,"y":2900,"wires":[]},{"id":"ce78c765.6d0b3","type":"template","z":"e9cabb74.fe91","name":"Success","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Success creating test PDF using : {{datamap}} and {{template}} !","output":"str","x":1320,"y":2900,"wires":[["3b6c7a8f.e03d06"]]},{"id":"d301d0f2.af344","type":"change","z":"e9cabb74.fe91","name":"set template filename","rules":[{"t":"set","p":"filename","pt":"msg","to":"indexFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1640,"y":2260,"wires":[["42a0d310.67de04"]]},{"id":"42a0d310.67de04","type":"file","z":"e9cabb74.fe91","name":"write index.json","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1620,"y":2300,"wires":[[]]},{"id":"6af0b132.db217","type":"comment","z":"e9cabb74.fe91","name":"Send datamap to filestore persitent","info":"","x":840,"y":2300,"wires":[]},{"id":"90ab1182.c36d68","type":"comment","z":"e9cabb74.fe91","name":"Test with a small PDF","info":"","x":1360,"y":2640,"wires":[]},{"id":"6cd9318b.dd8308","type":"template","z":"e9cabb74.fe91","name":"Error","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Error missing parts in package : {{payload}} !","output":"str","x":250,"y":2680,"wires":[["48ef3051.784ee"]]},{"id":"25cfc900.c8273","type":"change","z":"e9cabb74.fe91","name":"set template filename","rules":[{"t":"set","p":"filename","pt":"msg","to":"testPdfFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":2800,"wires":[["92febe9c.489678"]]},{"id":"b9be550c.eb9b3","type":"fs-ops-dir","z":"e9cabb74.fe91","name":"List file","path":"path","pathType":"msg","filter":"*.*","filterType":"str","dir":"files","dirType":"msg","x":540,"y":1420,"wires":[["5b80b04d.ad8d88"]]},{"id":"6d9f22b5.141f14","type":"function","z":"e9cabb74.fe91","name":"Set path","func":"msg.bank = msg.payload.bank;\nmsg.path = flow.get(\"templatePath\") + '/'+ msg.bank\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":1420,"wires":[["b9be550c.eb9b3"]]},{"id":"5b80b04d.ad8d88","type":"fs-ops-type","z":"e9cabb74.fe91","name":"","path":"path","pathType":"msg","filename":"files","filenameType":"msg","filetype":"type","filetypeType":"msg","x":680,"y":1420,"wires":[["ea69d5bf.f3cdd8"]]},{"id":"1ddaaf89.e0d718","type":"file in","z":"e9cabb74.fe91","name":"load the .ol-datamap","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":800,"y":2140,"wires":[["4aa153b0.529234"]]},{"id":"4aa153b0.529234","type":"zip","z":"e9cabb74.fe91","name":"unzip","mode":"decompress","filename":"","outasstring":false,"x":750,"y":2180,"wires":[["3c7b1b3.00fb8e4"]]},{"id":"3c7b1b3.00fb8e4","type":"function","z":"e9cabb74.fe91","name":"find sample data file","func":"var index = msg.payload.find(obj => obj.filename.startsWith(\"SampleDataFiles\"));\nif (index) {\n//    var b=Buffer.from(index.payload);\n    msg.filename = msg.dataFilename;\n    msg.payload = index.payload; \n    return msg;\n} else {\n    return;\n}\n","outputs":1,"noerr":0,"x":800,"y":2220,"wires":[["14880e43.47e0aa"]]},{"id":"5a49f57.af7930c","type":"comment","z":"e9cabb74.fe91","name":"Extract sample data","info":"","x":790,"y":2060,"wires":[]},{"id":"14880e43.47e0aa","type":"file","z":"e9cabb74.fe91","name":"Write data file","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":780,"y":2260,"wires":[["bd4562ae.dfae9"]]},{"id":"bd4562ae.dfae9","type":"change","z":"e9cabb74.fe91","name":"","rules":[{"t":"set","p":"filename","pt":"msg","to":"datamapFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":2340,"wires":[["4fd02093.e9eae"]]},{"id":"92febe9c.489678","type":"file","z":"e9cabb74.fe91","name":"Write sample pdf ","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1350,"y":2840,"wires":[["ce78c765.6d0b3"]]},{"id":"ea69d5bf.f3cdd8","type":"function","z":"e9cabb74.fe91","name":"return only directories","func":"msg.payload = [];\nfor (var i = 0; i < msg.files.length; i++) {\n    if (msg.type[i] == 'D') {\n        msg.payload.push(msg.files[i])\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":1420,"wires":[["93660c35.66da68"]]},{"id":"398d217e.f44326","type":"http in","z":"e9cabb74.fe91","name":"","url":"/templates","method":"get","upload":false,"swaggerDoc":"","x":240,"y":1420,"wires":[["6d9f22b5.141f14"]]},{"id":"81e5420e.18c5c","type":"file","z":"e9cabb74.fe91","name":"Write modified template","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1370,"y":2500,"wires":[["aeb255d8.9a29b"]]},{"id":"d7b1e5ab.23fd7","type":"change","z":"e9cabb74.fe91","name":"set template filename","rules":[{"t":"set","p":"filename","pt":"msg","to":"templateFilename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":2460,"wires":[["81e5420e.18c5c"]]},{"id":"635cb2cb.e481cc","type":"comment","z":"e9cabb74.fe91","name":"-------------- get templates name for specific bank in the file store","info":"","x":390,"y":1380,"wires":[]},{"id":"2ee9e32f.0d9c34","type":"function","z":"e9cabb74.fe91","name":"Set filename","func":"msg.bank = msg.payload.bank;\nmsg.template = msg.payload.template;\nmsg.filename = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.template + '/index.json';\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1500,"wires":[["34cd3f9c.20bac8"]]},{"id":"34cd3f9c.20bac8","type":"file in","z":"e9cabb74.fe91","name":"get index.json","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":580,"y":1500,"wires":[["a4de6bef.e005e8"]]},{"id":"a4de6bef.e005e8","type":"json","z":"e9cabb74.fe91","name":"","property":"payload","action":"","pretty":false,"x":750,"y":1500,"wires":[["93660c35.66da68"]]},{"id":"5499569a.8c507","type":"mysql","z":"e9cabb74.fe91","mydb":"8472406d.86a92","name":"objectiflune","x":550,"y":1580,"wires":[["93660c35.66da68"]]},{"id":"544feafa.c4cdac","type":"change","z":"e9cabb74.fe91","name":"managedfile","rules":[{"t":"set","p":"topic","pt":"msg","to":"SELECT * FROM objectiflune.managedfile WHERE DATECREATED = \"9999-10-09 00:00:00\"","tot":"str"},{"t":"set","p":"bank","pt":"msg","to":"payload.bank","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":1580,"wires":[["5499569a.8c507"]]},{"id":"5efb0787.0b22e8","type":"http in","z":"e9cabb74.fe91","name":"","url":"/files","method":"get","upload":false,"swaggerDoc":"","x":220,"y":1580,"wires":[["544feafa.c4cdac"]]},{"id":"86120076.56bb68","type":"comment","z":"e9cabb74.fe91","name":"-------------- get persistent file in the file store","info":"","x":330,"y":1540,"wires":[]},{"id":"ffec771d.b1af88","type":"comment","z":"e9cabb74.fe91","name":"---- For debug purpose ----","info":"","x":1170,"y":620,"wires":[]},{"id":"5afc7c9d.324984","type":"http in","z":"e9cabb74.fe91","name":"","url":"/connecttemplate","method":"post","upload":false,"swaggerDoc":"","x":240,"y":3060,"wires":[["c8d21261.e183a","a6a5aa5f.2522c"]]},{"id":"79c62134.481db","type":"comment","z":"e9cabb74.fe91","name":"-------------- get connect template","info":"","x":270,"y":3020,"wires":[]},{"id":"c8d21261.e183a","type":"function","z":"e9cabb74.fe91","name":"Set path","func":"msg.bank = msg.payload.bank;\nmsg.template = msg.payload.template;\nmsg.path = flow.get(\"templatePath\") + '/'+ msg.bank + '/' + msg.template;\nmsg.WPdata = msg.payload.WPdata;\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":3140,"wires":[["ff3dd030.6a3ae8"]]},{"id":"d6ac42fd.a7c238","type":"file in","z":"e9cabb74.fe91","name":"load template file","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":350,"y":3260,"wires":[["af2cb393.7352d"]]},{"id":"ff3dd030.6a3ae8","type":"fs-ops-dir","z":"e9cabb74.fe91","name":"get ol-template","path":"path","pathType":"msg","filter":"*.OL-template","filterType":"str","dir":"payload","dirType":"msg","x":340,"y":3180,"wires":[["d55c9738.c9f758"]]},{"id":"d55c9738.c9f758","type":"function","z":"e9cabb74.fe91","name":"set filename","func":"msg.filename = msg.path + '/' + msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":3220,"wires":[["d6ac42fd.a7c238"]]},{"id":"873838c6.edbe38","type":"http response","z":"e9cabb74.fe91","name":"200 application/octet-stream","statusCode":"200","headers":{"content-type":"application/octet-stream"},"x":1400,"y":3060,"wires":[]},{"id":"b7a0bb34.b66578","type":"base64","z":"e9cabb74.fe91","name":"convert to base 64","action":"","property":"payload","x":1150,"y":3060,"wires":[["873838c6.edbe38"]]},{"id":"a6a5aa5f.2522c","type":"debug","z":"e9cabb74.fe91","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":3040,"wires":[]},{"id":"af2cb393.7352d","type":"zip","z":"e9cabb74.fe91","name":"unzip","mode":"decompress","filename":"","outasstring":false,"x":310,"y":3320,"wires":[["fb3424db.6dc338"]]},{"id":"fb3424db.6dc338","type":"function","z":"e9cabb74.fe91","name":"find index.xml","func":"\nmsg.zip = msg.payload; // keep the zip\nvar index = msg.payload.find(obj => obj.filename == 'index.xml');\nif (index) {\n    var b=Buffer.from(index.payload);\n    msg.payload = b.toString(); \n    return msg;\n} else {\n    return;\n}\n","outputs":1,"noerr":0,"x":340,"y":3360,"wires":[["89054e45.545338"]]},{"id":"89054e45.545338","type":"xml","z":"e9cabb74.fe91","name":"xml -> json","property":"payload","attr":"","chr":"","x":330,"y":3400,"wires":[["feb5ecfb.68e5a"]]},{"id":"feb5ecfb.68e5a","type":"function","z":"e9cabb74.fe91","name":"inject control script","func":"\n// find to see if the TED conditional is present\nvar script = msg.payload.package.scripts[0].script.find(obj => obj.name == 'TED conditional background');\n\n\n// if so replace the code by local one\nif (script) {\n    script.source = [flow.get('tedCondition')];\n} else {\n    msg.payload.package.scripts[0].script.unshift(\n        {\n            \"$\":{\"type\":\"STANDARD\"},\n            \"enabled\":[\"true\"],\n            \"findText\":[\"\"],\n            \"name\":[\"TED conditional background\"],\n            \"origin\":[\"\"],\n            \"selectorText\":[\"[section] body\"],\n            \"selectorType\":[\"QUERY\"],\n            \"source\":['WPdata = JSON.parse(record.fields.WPdata);\\n' + flow.get('tedCondition')]\n        }\n    );\n}\n\nscript = msg.payload.package.scripts[0].script.find(obj => obj.name == 'TED payload');\n\nif (script) {\n    script.source = ['WPdata = ' + msg.WPdata + ';\\n' + flow.get('tedPayload')];\n} else {\n    msg.payload.package.scripts[0].script.unshift(\n        {\n            \"$\": {\"type\": \"CONTROL\"},\n            \"enabled\": [\"true\"],\n            \"findText\": [\"\"],\n            \"name\": [\"TED payload\"],\n            \"origin\": [\"\"],\n            \"selectorText\": [\"\"],\n            \"selectorType\": [\"QUERY\"],\n            \"source\": ['WPdata = ' + msg.WPdata + ';\\n' + flow.get('tedPayload')]\n        }\n    );\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":3440,"wires":[["3a75913f.ef3c46"]]},{"id":"3a75913f.ef3c46","type":"xml","z":"e9cabb74.fe91","name":"json -> xml","property":"payload","attr":"","chr":"","x":330,"y":3480,"wires":[["bdb023cc.180e2"]]},{"id":"bdb023cc.180e2","type":"function","z":"e9cabb74.fe91","name":"store index.xml","func":"\nvar index = msg.zip.find(obj => obj.filename == 'index.xml');\nif (index) {\n    index.payload = new Buffer(msg.payload);\n}\nmsg.payload = msg.zip;\ndelete msg.filename; // otherwise it confuse the zip plugin\nreturn msg;\n","outputs":1,"noerr":0,"x":340,"y":3520,"wires":[["654979b6.a7b37"]]},{"id":"654979b6.a7b37","type":"zip","z":"e9cabb74.fe91","name":"zip","mode":"compress","filename":"","outasstring":false,"x":310,"y":3560,"wires":[["b7a0bb34.b66578"]]}]